# Docker Compose version - defines feature compatibility
version: '3.8'

# Define all services (containers) for the LEMP stack
services:

  # NGINX - Web server and reverse proxy (entry point)
  nginx:
    container_name: nginx                    # Custom container name instead of auto-generated
    build:
      context: ./requirements/nginx         # Build context directory
      dockerfile: Dockerfile               # Dockerfile name (default, but explicit)
    ports:
      - "443:443"                          # Map host port 443 to container port 443 (HTTPS only)
    depends_on:
      - wordpress                          # Start wordpress before nginx (dependency order)
    restart: always                        # Auto-restart container if it crashes
    env_file:
      - .env                              # Load environment variables from .env file
    volumes:
      - wordpress_data:/var/www/html       # Mount shared WordPress files (read-only for nginx)
    networks:
      - inception                          # Connect to custom bridge network

  # WORDPRESS - PHP application server with PHP-FPM
  wordpress:
    container_name: wordpress              # Custom container name
    build:
      context: ./requirements/wordpress    # Build context directory
      dockerfile: Dockerfile              # Custom Dockerfile for WordPress + PHP-FPM
    expose:
      - 9000                              # Internal port for FastCGI (not exposed to host)
    env_file:
      - .env                              # Database credentials and WordPress config
    depends_on:
      - mariadb                           # Start database before WordPress
    restart: always                       # Auto-restart on failure
    volumes:
      - wordpress_data:/var/www/html      # Mount WordPress files (read-write access)
    networks:
      - inception                         # Same network as nginx for communication

  # MARIADB - Database server
  mariadb:
    container_name: mariadb               # Custom container name
    build:
      context: ./requirements/mariadb     # Build context directory
      dockerfile: Dockerfile             # Custom Dockerfile for MariaDB setup
    expose:
      - 3306                             # Internal MySQL port (not exposed to host)
    env_file:
      - .env                             # Database credentials and configuration
    restart: always                      # Auto-restart on failure
    volumes:
      - mariadb_data:/var/lib/mysql      # Mount database files for persistence
    networks:
      - inception                        # Same network for WordPress communication


# Volume definitions - persistent storage that survives container recreation
volumes:
  # WordPress files volume (shared between nginx and wordpress)
  wordpress_data:
    driver_opts:
      o: 'bind'                                    # Bind mount type
      type: 'none'                                 # No special filesystem type
      device: '/tmp/inception_data/wordpress_vol'    # Host directory path (local testing)
      # device: '/home/aalshafy/data/wordpress_vol'   # Original path for school Mac

  # Database files volume (exclusive to mariadb)
  mariadb_data:
    driver_opts:
      o: 'bind'                                    # Bind mount type
      type: 'none'                                 # No special filesystem type
      device: '/tmp/inception_data/mariadb_vol'      # Host directory path (local testing)
      # device: '/home/aalshafy/data/mariadb_vol'     # Original path for school Mac

# Network definitions - virtual networks for container communication
networks:
  inception:
    driver: bridge                        # Bridge network type (default, isolated from host)